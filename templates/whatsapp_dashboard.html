{% extends "base.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨{% endblock %}

{% block content %}
<div class="row">
    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fab fa-whatsapp"></i> Ø­Ø§Ù„Ø© Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="status-indicator {{ 'status-connected' if session_data and session_data.status == 'connected' else 'status-disconnected' }}"></div>
                    <span class="ms-2 fw-bold">
                        {% if session_data and session_data.status == 'connected' %}
                            Ù…ØªØµÙ„
                        {% elif session_data and session_data.status == 'qr_code' %}
                            ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­
                        {% else %}
                            ØºÙŠØ± Ù…ØªØµÙ„
                        {% endif %}
                    </span>
                </div>
                
                {% if session_data and session_data.status == 'connected' %}
                <div class="mb-3">
                    <strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ session_data.phone_number or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}<br>
                    <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ØªØµØ§Ù„:</strong> {{ session_data.connected_at or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}<br>
                    <strong>Ù…Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</strong> <span id="connection-duration">Ø­Ø³Ø§Ø¨...</span>
                </div>
                {% endif %}
                
                <div class="btn-group w-100" role="group">
                    {% if session_data and session_data.status == 'connected' %}
                    <button class="btn btn-danger" onclick="disconnectBot()">
                        <i class="fas fa-stop"></i> Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                    {% else %}
                    <button class="btn btn-success" onclick="connectBot()">
                        <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                    {% endif %}
                    <button class="btn btn-warning" onclick="restartBot()">
                        <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø±Ù…Ø² QR -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-qrcode"></i> Ø±Ù…Ø² QR Ù„Ù„Ø§ØªØµØ§Ù„</h5>
            </div>
            <div class="card-body text-center">
                <div id="qr-container" class="text-center">
                    <div id="qr-content">
                        <!-- Ù…Ø­ØªÙˆÙ‰ Ø±Ù…Ø² QR Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ù€ JavaScript -->
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="refreshQR()" id="refresh-qr-btn">
                        <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø²
                    </button>
                    <button class="btn btn-outline-secondary" onclick="checkStatus()" id="check-status-btn">
                        <i class="fas fa-search"></i> ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø³Ø© -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ stats.total_messages or 0 }}</h4>
                        <small class="text-muted">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ stats.active_sessions or 0 }}</h4>
                        <small class="text-muted">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-info">{{ stats.total_clients or 0 }}</h4>
                        <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ stats.total_numbers or 0 }}</h4>
                        <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø© -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø©</h5>
            </div>
            <div class="card-body">
                <form id="quick-message-form">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control" id="phone-number" placeholder="967xxxxxxxxx" required>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                            <textarea class="form-control" id="message-text" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." required></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    </button>
                </form>
                <div id="message-result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«
                </button>
            </div>
            <div class="card-body">
                <div id="activity-logs">
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ØªØ­Ø¯ÙŠØ« Ù…Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
{% if session_data and session_data.connected_at %}
function updateConnectionDuration() {
    const connectedAt = new Date('{{ session_data.connected_at }}');
    const now = new Date();
    const diff = now - connectedAt;
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('connection-duration').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

setInterval(updateConnectionDuration, 1000);
updateConnectionDuration();
{% endif %}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
async function connectBot() {
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„...');
    try {
        const response = await fetch('/api/whatsapp/connect', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showSuccess('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ù…Ø² QR');
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø©
            startStatusMonitoring();
        } else {
            showError(data.message || 'ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
    } catch (error) {
        showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ' + error.message);
    }
}

async function disconnectBot() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ØŸ')) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª...');
    try {
        const response = await fetch('/api/whatsapp/disconnect', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showSuccess('ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            stopStatusMonitoring();
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(data.message || 'ÙØ´Ù„ ÙÙŠ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
    } catch (error) {
        showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ' + error.message);
    }
}

async function restartBot() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØªØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.')) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...');
    try {
        const response = await fetch('/api/whatsapp/restart', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showSuccess('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù…Ø² QR Ø¬Ø¯ÙŠØ¯');
            stopStatusMonitoring();
            setTimeout(() => {
                startStatusMonitoring();
            }, 3000);
        } else {
            showError(data.message || 'ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„');
        }
    } catch (error) {
        showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ' + error.message);
    }
}


// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
let statusMonitorInterval = null;

function startStatusMonitoring() {
    if (statusMonitorInterval) {
        clearInterval(statusMonitorInterval);
    }
    
    // ÙØ­Øµ ÙÙˆØ±ÙŠ
    updateStatus();
    
    // ÙØ­Øµ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù Ù„Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·ÙŠØ¦Ø©
    statusMonitorInterval = setInterval(updateStatus, 10000);
    console.log('ØªÙ… Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù)');
}

function stopStatusMonitoring() {
    if (statusMonitorInterval) {
        clearInterval(statusMonitorInterval);
        statusMonitorInterval = null;
        console.log('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©');
    }
}

async function updateStatus() {
    try {
        console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª...');
        const response = await fetch('/api/whatsapp/status');
        const data = await response.json();
        
        console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©:', data);
        
        if (data.success) {
            updateQRDisplay(data);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ØªØµÙ„Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙƒØ«ÙØ© Ù„Ù€ QR
            if (data.status === 'disconnected' || data.status === 'waiting') {
                console.log('â³ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ØªØµÙ„ - Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø±Ù…Ø² QR');
                // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‡Ù†Ø§
            } else if (data.status === 'qr_generated' && data.qr_code) {
                console.log('ğŸ“± ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² QR!');
                updateQRDisplay({
                    status: 'qr',
                    qr: data.qr_code,
                    sessionId: data.session_id || 'whatsapp_main_session'
                });
            } else if (data.status === 'connected') {
                console.log('âœ… Ø§Ù„Ø¨ÙˆØª Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        } else {
            console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª:', data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            
            // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù€ Node.js
            try {
                console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Node.js...');
                const nodeResponse = await fetch('http://localhost:3000/api/status');
                const nodeData = await nodeResponse.json();
                console.log('ğŸ“¡ Ø¨ÙŠØ§Ù†Ø§Øª Node.js Ù…Ø¨Ø§Ø´Ø±Ø©:', nodeData);
                
                if (nodeData.qr) {
                    console.log('ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ QR Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Node.js!');
                    updateQRDisplay({
                        status: 'qr',
                        qr: nodeData.qr,
                        sessionId: nodeData.sessionId || 'whatsapp_main_session'
                    });
                }
            } catch (nodeError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Node.js:', nodeError);
            }
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª:', error);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        try {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Node.js...');
            const emergencyResponse = await fetch('http://localhost:3000/api/status');
            const emergencyData = await emergencyResponse.json();
            console.log('ğŸš¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:', emergencyData);
            
            if (emergencyData.qr || emergencyData.status === 'qr') {
                updateQRDisplay({
                    status: 'qr', 
                    qr: emergencyData.qr,
                    sessionId: emergencyData.sessionId || 'whatsapp_main_session'
                });
            }
        } catch (emergencyError) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:', emergencyError);
        }
    }
}

function updateQRDisplay(data) {
    const qrContent = document.getElementById('qr-content');
    
    console.log('ğŸ¨ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ QR:', data);
    
    if (data.status === 'connected' && data.isConnected) {
        qrContent.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle fa-3x mb-2 d-block"></i>
                <h5>Ø§Ù„Ø¨ÙˆØª Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h5>
                <p class="mb-1"><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${data.phone_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                <p class="mb-0"><strong>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©:</strong> ${data.sessionId}</p>
            </div>
        `;
    } else if ((data.status === 'qr' && data.qr) || (data.status === 'qr_generated' && data.qr_code)) {
        const qrData = data.qr || data.qr_code;
        const sessionId = data.sessionId || data.session_id || 'whatsapp_main_session';
        
        console.log('âœ… Ø¹Ø±Ø¶ Ø±Ù…Ø² QR:', qrData ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù…ÙÙ‚ÙˆØ¯');
        
        qrContent.innerHTML = `
            <div class="alert alert-info mb-3">
                <i class="fas fa-qrcode fa-2x mb-2 d-block"></i>
                <h6>Ø±Ù…Ø² QR Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­</h6>
                <small class="text-muted">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø² ÙÙŠ: ${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="mb-3">
                <a href="http://localhost:3000/qr?data=${encodeURIComponent(qrData)}" target="_blank" class="btn btn-outline-primary mb-3">
                    <i class="fas fa-external-link-alt me-1"></i> ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </a>
                <button onclick="refreshQR()" class="btn btn-outline-secondary mb-3 ms-2">
                    <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                </button>
            </div>
            <div class="qr-display p-3 border rounded bg-white text-center">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(qrData)}" 
                     alt="QR Code" class="img-fluid" style="max-width: 220px; border: 2px solid #25D366; border-radius: 8px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display: none;" class="text-center p-3">
                    <p class="text-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø±Ù…Ø² QR</p>
                    <button class="btn btn-sm btn-primary" onclick="window.open('http://localhost:3000/qr?data=${encodeURIComponent(qrData)}', '_blank')">
                        ÙØªØ­ Ø§Ù„Ø±Ù…Ø² Ù…Ø¨Ø§Ø´Ø±Ø©
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <h6 class="text-primary">ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø­:</h6>
                <div class="bg-light p-3 rounded">
                    <ol class="text-start mb-0 small">
                        <li><strong>Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§ØªØ³Ø§Ø¨</strong> Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø°ÙƒÙŠ</li>
                        <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« â‹®</strong> (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</li>
                        <li>Ø§Ø®ØªØ± <strong>"Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©"</strong></li>
                        <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>"Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²"</strong></li>
                        <li><strong>Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø£Ø¹Ù„Ø§Ù‡</strong> Ø¨ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù‡Ø§ØªÙ</li>
                    </ol>
                </div>
            </div>
            <div class="mt-3 p-2 bg-success bg-opacity-10 rounded">
                <small class="text-success">
                    <i class="fas fa-info-circle"></i>
                    <strong>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©:</strong> ${sessionId} | 
                    <strong>Ø§Ù„ØªØ­Ø¯ÙŠØ«:</strong> ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
                </small>
            </div>
        `;
    } else if (data.status === 'server_stopped') {
        qrContent.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle fa-3x mb-2 d-block"></i>
                <h6>Ø®Ø§Ø¯Ù… Node.js Ù…ØªÙˆÙ‚Ù</h6>
                <p class="mb-0">ÙŠØ±Ø¬Ù‰ Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…</p>
            </div>
        `;
    } else {
        qrContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle fa-3x mb-2 d-block"></i>
                <h6>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡</h6>
                <p class="mb-0">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR</p>
            </div>
        `;
    }
}

function updateConnectionInfo(data) {
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = statusIndicator?.nextElementSibling;
    
    if (statusIndicator && statusText) {
        if (data.status === 'connected' && data.isConnected) {
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = 'Ù…ØªØµÙ„';
        } else if (data.status === 'qr') {
            statusIndicator.className = 'status-indicator status-qr';
            statusText.textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­';
        } else {
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        }
    }
}

async function refreshQR() {
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©...');
    await updateStatus();
    hideLoading();
}

async function checkStatus() {
    showLoading('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©...');
    await updateStatus();
    hideLoading();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø©
document.getElementById('quick-message-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phone-number').value;
    const messageText = document.getElementById('message-text').value;
    const resultDiv = document.getElementById('message-result');
    
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©...</div>';
    
    try {
        const response = await fetch('/api/bot/send-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phoneNumber, message: messageText })
        });
        
        const data = await response.json();
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­</div>';
            document.getElementById('quick-message-form').reset();
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${data.message}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ${error.message}</div>`;
    }
});

// ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©
async function refreshLogs() {
    const logsDiv = document.getElementById('activity-logs');
    logsDiv.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...</div>';
    
    try {
        const response = await fetch('/api/bot/logs');
        const data = await response.json();
        
        if (data.success && data.logs.length > 0) {
            let logsHtml = '<div class="list-group">';
            data.logs.forEach(log => {
                const logClass = log.level === 'error' ? 'list-group-item-danger' : 
                                log.level === 'warning' ? 'list-group-item-warning' : 
                                'list-group-item-light';
                logsHtml += `
                    <div class="list-group-item ${logClass}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${log.message}</h6>
                            <small>${log.timestamp}</small>
                        </div>
                        ${log.details ? `<p class="mb-1 small text-muted">${log.details}</p>` : ''}
                    </div>
                `;
            });
            logsHtml += '</div>';
            logsDiv.innerHTML = logsHtml;
        } else {
            logsDiv.innerHTML = '<div class="text-center py-3 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
        }
    } catch (error) {
        logsDiv.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>';
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', refreshLogs);

// ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
    refreshLogs();
}, 30000);

// Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    startStatusMonitoring();
});

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', function() {
    stopStatusMonitoring();
});
</script>
{% endblock %}
