{% extends "base.html" %}

{% block title %}لوحة إدارة بوت واتساب{% endblock %}

{% block content %}
<div class="row">
    <!-- حالة البوت -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fab fa-whatsapp"></i> حالة بوت واتساب</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="status-indicator {{ 'status-connected' if session_data and session_data.status == 'connected' else 'status-disconnected' }}"></div>
                    <span class="ms-2 fw-bold">
                        {% if session_data and session_data.status == 'connected' %}
                            متصل
                        {% elif session_data and session_data.status == 'qr_code' %}
                            في انتظار المسح
                        {% else %}
                            غير متصل
                        {% endif %}
                    </span>
                </div>
                
                {% if session_data and session_data.status == 'connected' %}
                <div class="mb-3">
                    <strong>رقم الهاتف:</strong> {{ session_data.phone_number or 'غير محدد' }}<br>
                    <strong>تاريخ الاتصال:</strong> {{ session_data.connected_at or 'غير محدد' }}<br>
                    <strong>مدة الاتصال:</strong> <span id="connection-duration">حساب...</span>
                </div>
                {% endif %}
                
                <div class="btn-group w-100" role="group">
                    {% if session_data and session_data.status == 'connected' %}
                    <button class="btn btn-danger" onclick="disconnectBot()">
                        <i class="fas fa-stop"></i> قطع الاتصال
                    </button>
                    {% else %}
                    <button class="btn btn-success" onclick="connectBot()">
                        <i class="fas fa-play"></i> بدء الاتصال
                    </button>
                    {% endif %}
                    <button class="btn btn-warning" onclick="restartBot()">
                        <i class="fas fa-redo"></i> إعادة تشغيل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- رمز QR -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-qrcode"></i> رمز QR للاتصال</h5>
            </div>
            <div class="card-body text-center">
                <div id="qr-container" class="text-center">
                    <div id="qr-content">
                        <!-- محتوى رمز QR سيتم تحديثه بـ JavaScript -->
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="refreshQR()" id="refresh-qr-btn">
                        <i class="fas fa-sync"></i> تحديث الرمز
                    </button>
                    <button class="btn btn-outline-secondary" onclick="checkStatus()" id="check-status-btn">
                        <i class="fas fa-search"></i> فحص الحالة
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- إحصائيات الجلسة -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> إحصائيات الجلسة</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ stats.total_messages or 0 }}</h4>
                        <small class="text-muted">الرسائل المرسلة</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ stats.active_sessions or 0 }}</h4>
                        <small class="text-muted">الجلسات النشطة</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-info">{{ stats.total_clients or 0 }}</h4>
                        <small class="text-muted">إجمالي العملاء</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ stats.total_numbers or 0 }}</h4>
                        <small class="text-muted">إجمالي الأرقام</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- إرسال رسالة سريعة -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-paper-plane"></i> إرسال رسالة سريعة</h5>
            </div>
            <div class="card-body">
                <form id="quick-message-form">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">رقم الهاتف</label>
                            <input type="text" class="form-control" id="phone-number" placeholder="967xxxxxxxxx" required>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label class="form-label">الرسالة</label>
                            <textarea class="form-control" id="message-text" rows="3" placeholder="اكتب رسالتك هنا..." required></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> إرسال الرسالة
                    </button>
                </form>
                <div id="message-result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- سجل الأنشطة -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> سجل الأنشطة الأخيرة</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> تحديث
                </button>
            </div>
            <div class="card-body">
                <div id="activity-logs">
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin"></i> جاري تحميل السجلات...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// تحديث مدة الاتصال
{% if session_data and session_data.connected_at %}
function updateConnectionDuration() {
    const connectedAt = new Date('{{ session_data.connected_at }}');
    const now = new Date();
    const diff = now - connectedAt;
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('connection-duration').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

setInterval(updateConnectionDuration, 1000);
updateConnectionDuration();
{% endif %}

// وظائف التحكم بالبوت المحدثة
async function connectBot() {
    showLoading('جاري بدء الاتصال...');
    try {
        const response = await fetch('/api/whatsapp/connect', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showSuccess('تم بدء الاتصال بنجاح - يرجى انتظار رمز QR');
            // بدء مراقبة الحالة
            startStatusMonitoring();
        } else {
            showError(data.message || 'فشل في بدء الاتصال');
        }
    } catch (error) {
        showError('خطأ في الشبكة: ' + error.message);
    }
}

async function disconnectBot() {
    if (!confirm('هل أنت متأكد من قطع الاتصال؟')) return;
    
    showLoading('جاري قطع الاتصال وحذف الجلسات...');
    try {
        const response = await fetch('/api/whatsapp/disconnect', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showSuccess('تم قطع الاتصال وحذف جميع الجلسات بنجاح');
            stopStatusMonitoring();
            setTimeout(() => location.reload(), 2000);
        } else {
            showError(data.message || 'فشل في قطع الاتصال');
        }
    } catch (error) {
        showError('خطأ في الشبكة: ' + error.message);
    }
}

async function restartBot() {
    if (!confirm('هل أنت متأكد من إعادة تشغيل البوت؟ سيتم حذف جميع الجلسات القديمة.')) return;
    
    showLoading('جاري إعادة التشغيل وحذف الجلسات القديمة...');
    try {
        const response = await fetch('/api/whatsapp/restart', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            showSuccess('تم إعادة التشغيل بنجاح - جاري البحث عن رمز QR جديد');
            stopStatusMonitoring();
            setTimeout(() => {
                startStatusMonitoring();
            }, 3000);
        } else {
            showError(data.message || 'فشل في إعادة التشغيل');
        }
    } catch (error) {
        showError('خطأ في الشبكة: ' + error.message);
    }
}


// مراقبة الحالة التلقائية
let statusMonitorInterval = null;

function startStatusMonitoring() {
    if (statusMonitorInterval) {
        clearInterval(statusMonitorInterval);
    }
    
    // فحص فوري
    updateStatus();
    
    // فحص كل 10 ثوانِ للشبكة البطيئة
    statusMonitorInterval = setInterval(updateStatus, 10000);
    console.log('تم بدء مراقبة الحالة التلقائية (كل 10 ثوانِ)');
}

function stopStatusMonitoring() {
    if (statusMonitorInterval) {
        clearInterval(statusMonitorInterval);
        statusMonitorInterval = null;
        console.log('تم إيقاف مراقبة الحالة التلقائية');
    }
}

async function updateStatus() {
    try {
        console.log('🔍 فحص حالة البوت...');
        const response = await fetch('/api/whatsapp/status');
        const data = await response.json();
        
        console.log('📊 بيانات الحالة:', data);
        
        if (data.success) {
            updateQRDisplay(data);
            
            // إذا كانت الحالة غير متصلة، ابدأ المراقبة المكثفة لـ QR
            if (data.status === 'disconnected' || data.status === 'waiting') {
                console.log('⏳ البوت غير متصل - استمرار المراقبة لرمز QR');
                // لا نوقف المراقبة هنا
            } else if (data.status === 'qr_generated' && data.qr_code) {
                console.log('📱 تم العثور على رمز QR!');
                updateQRDisplay({
                    status: 'qr',
                    qr: data.qr_code,
                    sessionId: data.session_id || 'whatsapp_main_session'
                });
            } else if (data.status === 'connected') {
                console.log('✅ البوت متصل بنجاح');
            }
        } else {
            console.error('فشل في جلب حالة البوت:', data.message || 'خطأ غير محدد');
            
            // في حالة فشل الاتصال، حاول الاتصال المباشر بـ Node.js
            try {
                console.log('🔄 محاولة اتصال مباشر مع Node.js...');
                const nodeResponse = await fetch('http://localhost:3000/api/status');
                const nodeData = await nodeResponse.json();
                console.log('📡 بيانات Node.js مباشرة:', nodeData);
                
                if (nodeData.qr) {
                    console.log('🎯 تم العثور على QR مباشرة من Node.js!');
                    updateQRDisplay({
                        status: 'qr',
                        qr: nodeData.qr,
                        sessionId: nodeData.sessionId || 'whatsapp_main_session'
                    });
                }
            } catch (nodeError) {
                console.error('❌ خطأ في الاتصال المباشر مع Node.js:', nodeError);
            }
        }
    } catch (error) {
        console.error('خطأ في فحص حالة البوت:', error);
        
        // محاولة أخيرة للاتصال المباشر
        try {
            console.log('🔄 محاولة طوارئ للاتصال مع Node.js...');
            const emergencyResponse = await fetch('http://localhost:3000/api/status');
            const emergencyData = await emergencyResponse.json();
            console.log('🚨 بيانات الطوارئ:', emergencyData);
            
            if (emergencyData.qr || emergencyData.status === 'qr') {
                updateQRDisplay({
                    status: 'qr', 
                    qr: emergencyData.qr,
                    sessionId: emergencyData.sessionId || 'whatsapp_main_session'
                });
            }
        } catch (emergencyError) {
            console.error('❌ فشل في محاولة الطوارئ:', emergencyError);
        }
    }
}

function updateQRDisplay(data) {
    const qrContent = document.getElementById('qr-content');
    
    console.log('🎨 تحديث عرض QR:', data);
    
    if (data.status === 'connected' && data.isConnected) {
        qrContent.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle fa-3x mb-2 d-block"></i>
                <h5>البوت متصل بنجاح!</h5>
                <p class="mb-1"><strong>رقم الهاتف:</strong> ${data.phone_number || 'غير محدد'}</p>
                <p class="mb-0"><strong>معرف الجلسة:</strong> ${data.sessionId}</p>
            </div>
        `;
    } else if ((data.status === 'qr' && data.qr) || (data.status === 'qr_generated' && data.qr_code)) {
        const qrData = data.qr || data.qr_code;
        const sessionId = data.sessionId || data.session_id || 'whatsapp_main_session';
        
        console.log('✅ عرض رمز QR:', qrData ? 'موجود' : 'مفقود');
        
        qrContent.innerHTML = `
            <div class="alert alert-info mb-3">
                <i class="fas fa-qrcode fa-2x mb-2 d-block"></i>
                <h6>رمز QR جاهز للمسح</h6>
                <small class="text-muted">تم إنشاء الرمز في: ${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="mb-3">
                <a href="http://localhost:3000/qr?data=${encodeURIComponent(qrData)}" target="_blank" class="btn btn-outline-primary mb-3">
                    <i class="fas fa-external-link-alt me-1"></i> فتح في نافذة جديدة
                </a>
                <button onclick="refreshQR()" class="btn btn-outline-secondary mb-3 ms-2">
                    <i class="fas fa-sync-alt"></i> تحديث
                </button>
            </div>
            <div class="qr-display p-3 border rounded bg-white text-center">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(qrData)}" 
                     alt="QR Code" class="img-fluid" style="max-width: 220px; border: 2px solid #25D366; border-radius: 8px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display: none;" class="text-center p-3">
                    <p class="text-danger">خطأ في تحميل رمز QR</p>
                    <button class="btn btn-sm btn-primary" onclick="window.open('http://localhost:3000/qr?data=${encodeURIComponent(qrData)}', '_blank')">
                        فتح الرمز مباشرة
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <h6 class="text-primary">📋 تعليمات المسح:</h6>
                <div class="bg-light p-3 rounded">
                    <ol class="text-start mb-0 small">
                        <li><strong>افتح تطبيق واتساب</strong> على هاتفك الذكي</li>
                        <li>اضغط على <strong>النقاط الثلاث ⋮</strong> (القائمة)</li>
                        <li>اختر <strong>"الأجهزة المرتبطة"</strong></li>
                        <li>اضغط على <strong>"ربط جهاز"</strong></li>
                        <li><strong>امسح الرمز أعلاه</strong> بكاميرا الهاتف</li>
                    </ol>
                </div>
            </div>
            <div class="mt-3 p-2 bg-success bg-opacity-10 rounded">
                <small class="text-success">
                    <i class="fas fa-info-circle"></i>
                    <strong>معرف الجلسة:</strong> ${sessionId} | 
                    <strong>التحديث:</strong> كل 2 ثانية
                </small>
            </div>
        `;
    } else if (data.status === 'server_stopped') {
        qrContent.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle fa-3x mb-2 d-block"></i>
                <h6>خادم Node.js متوقف</h6>
                <p class="mb-0">يرجى بدء الاتصال لتشغيل الخادم</p>
            </div>
        `;
    } else {
        qrContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle fa-3x mb-2 d-block"></i>
                <h6>في انتظار البدء</h6>
                <p class="mb-0">اضغط على "بدء الاتصال" لإنشاء رمز QR</p>
            </div>
        `;
    }
}

function updateConnectionInfo(data) {
    // تحديث مؤشر الحالة والأزرار حسب الحالة
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = statusIndicator?.nextElementSibling;
    
    if (statusIndicator && statusText) {
        if (data.status === 'connected' && data.isConnected) {
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = 'متصل';
        } else if (data.status === 'qr') {
            statusIndicator.className = 'status-indicator status-qr';
            statusText.textContent = 'في انتظار المسح';
        } else {
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'غير متصل';
        }
    }
}

async function refreshQR() {
    showLoading('جاري تحديث الحالة...');
    await updateStatus();
    hideLoading();
}

async function checkStatus() {
    showLoading('جاري فحص الحالة...');
    await updateStatus();
    hideLoading();
}

// إرسال رسالة سريعة
document.getElementById('quick-message-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phone-number').value;
    const messageText = document.getElementById('message-text').value;
    const resultDiv = document.getElementById('message-result');
    
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري إرسال الرسالة...</div>';
    
    try {
        const response = await fetch('/api/bot/send-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phoneNumber, message: messageText })
        });
        
        const data = await response.json();
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> تم إرسال الرسالة بنجاح</div>';
            document.getElementById('quick-message-form').reset();
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> فشل الإرسال: ${data.message}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> خطأ في الشبكة: ${error.message}</div>`;
    }
});

// تحميل سجل الأنشطة
async function refreshLogs() {
    const logsDiv = document.getElementById('activity-logs');
    logsDiv.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> جاري تحميل السجلات...</div>';
    
    try {
        const response = await fetch('/api/bot/logs');
        const data = await response.json();
        
        if (data.success && data.logs.length > 0) {
            let logsHtml = '<div class="list-group">';
            data.logs.forEach(log => {
                const logClass = log.level === 'error' ? 'list-group-item-danger' : 
                                log.level === 'warning' ? 'list-group-item-warning' : 
                                'list-group-item-light';
                logsHtml += `
                    <div class="list-group-item ${logClass}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${log.message}</h6>
                            <small>${log.timestamp}</small>
                        </div>
                        ${log.details ? `<p class="mb-1 small text-muted">${log.details}</p>` : ''}
                    </div>
                `;
            });
            logsHtml += '</div>';
            logsDiv.innerHTML = logsHtml;
        } else {
            logsDiv.innerHTML = '<div class="text-center py-3 text-muted">لا توجد سجلات متاحة</div>';
        }
    } catch (error) {
        logsDiv.innerHTML = '<div class="alert alert-danger">خطأ في تحميل السجلات</div>';
    }
}

// تحميل السجلات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', refreshLogs);

// تحديث تلقائي كل 30 ثانية
setInterval(() => {
    refreshLogs();
}, 30000);

// بدء مراقبة الحالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    startStatusMonitoring();
});

// إيقاف المراقبة عند مغادرة الصفحة
window.addEventListener('beforeunload', function() {
    stopStatusMonitoring();
});
</script>
{% endblock %}
