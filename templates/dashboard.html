<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة إدارة العملاء</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin-bottom: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 25px;
    }
    .btn-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      border: none;
      border-radius: 25px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="#">
          <i class="fas fa-robot"></i> بوت واتساب
        </a>
        <div class="navbar-nav me-auto">
          <a class="nav-link active" href="/dashboard">
            <i class="fas fa-tachometer-alt"></i> لوحة الإدارة
          </a>
          <a class="nav-link active" href="/auto-query">
            <i class="fas fa-tachometer-alt"></i> إدارة الاستعلام التلقائي
          </a>
          <a class="nav-link" href="/history">
            <i class="fas fa-history"></i> سجلات الاستعلام
          </a>
          <a class="nav-link" href="/whatsapp">
            <i class="fab fa-whatsapp"></i> إدارة بوت واتساب
          </a>
          <a href="/packages" class="nav-link">
            <i class="fab fa-whatsapppp"></i> إدارة الباقات
          </a>
          <a href="/queries" class="nav-link">
            <i class="fab fa-whatsapppp"></i> سجلات الاستعلام المحدثة
          </a>
          <a href="/dashboard/clients2" class="btn btn-outline-primary">
            <i class="fas fa-users"></i> عرض العملاء
        </a>
        
        </div>
      </div>
    </nav>

    <div class="card mb-4">
      <div class="card-header">
        <h1 class="mb-0"><i class="fas fa-users text-primary"></i> لوحة إدارة العملاء</h1>
      </div>
      <div class="card-body">
        <!-- Node.js Server Management Card -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-primary">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-server"></i> إدارة خادم Node.js</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <div id="serverStatus" class="mb-3">
                      <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                          <span class="visually-hidden">جاري التحقق...</span>
                        </div>
                        <span>جاري فحص حالة الخادم...</span>
                      </div>
                    </div>
                    <p class="mb-2">التحكم في خادم Node.js الخاص ببوت واتساب</p>
                    <ul class="list-unstyled mb-3">
                      <li><i class="fas fa-check text-success"></i> تشغيل وإيقاف الخادم</li>
                      <li><i class="fas fa-check text-success"></i> فحص وتثبيت المكتبات تلقائياً</li>
                      <li><i class="fas fa-check text-success"></i> مراقبة حالة الخادم</li>
                      <li><i class="fas fa-check text-success"></i> إعادة تشغيل سريعة</li>
                    </ul>
                  </div>
                  <div class="col-md-4 text-center">
                    <div class="btn-group-vertical d-grid gap-2" role="group">
                      <button id="startServerBtn" class="btn btn-success" onclick="startNodeServer()">
                        <i class="fas fa-play"></i> تشغيل الخادم
                      </button>
                      <button id="stopServerBtn" class="btn btn-danger" onclick="stopNodeServer()">
                        <i class="fas fa-stop"></i> إيقاف الخادم
                      </button>
                      <button id="restartServerBtn" class="btn btn-warning" onclick="restartNodeServer()">
                        <i class="fas fa-redo"></i> إعادة تشغيل
                      </button>
                    </div>
                    <div id="serverMessage" class="mt-2"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- WhatsApp Bot Management Card -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fab fa-whatsapp"></i> إدارة بوت واتساب</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <p class="mb-2">إدارة بوت واتساب للإرسال التلقائي والتحكم في الجلسات</p>
                    <ul class="list-unstyled mb-3">
                      <li><i class="fas fa-check text-success"></i> مراقبة حالة الاتصال</li>
                      <li><i class="fas fa-check text-success"></i> إرسال الرسائل</li>
                      <li><i class="fas fa-check text-success"></i> إدارة الجلسات</li>
                      <li><i class="fas fa-check text-success"></i> عرض رمز QR</li>
                    </ul>
                  </div>
                  <div class="col-md-4 text-center">
                    <a href="/whatsapp" class="btn btn-success btn-lg">
                      <i class="fab fa-whatsapp"></i> فتح لوحة إدارة البوت
                    </a>
                    <p class="small text-muted mt-2">إدارة متكاملة في نفس النظام</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Client Section -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5><i class="fas fa-user-plus"></i> إضافة عميل جديد</h5>
              </div>
              <div class="card-body">
                <form method="post" action="/dashboard/add_client">
                  <div class="mb-3">
                    <label class="form-label">اسم العميل</label>
                    <input type="text" class="form-control" name="name" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">رقم واتساب (+967...)</label>
                    <input type="text" class="form-control" name="whatsapp" required placeholder="+967xxxxxxxxx">
                  </div>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> إضافة العميل
                  </button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5><i class="fas fa-search"></i> اختبار الاستعلام</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">رقم الهاتف للاختبار</label>
                  <input type="text" class="form-control" id="testNumber" placeholder="77712345">
                </div>
                <button type="button" class="btn btn-success" onclick="testQuery()">
                  <i class="fas fa-play"></i> اختبار الاستعلام
                </button>
                <div id="testResult" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Clients List -->
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-users"></i> قائمة العملاء ({{ clients|length }})</h5>
          </div>
          <div class="card-body">
            {% if clients %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>اسم العميل</th>
                    <th>رقم واتساب</th>
                    <th>عدد الأرقام</th>
                    <th>الأرقام المسجلة</th>
                    <th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody>
                  {% for client in clients %}
                  <tr>
                    <td>{{ client[0] }}</td>
                    <td>{{ client[1] }}</td>
                    <td>{{ client[2] }}</td>
                    <td><span class="badge bg-info">{{ client[3] }}</span></td>
                    <td>
                      {% if client[4] %}
                        <small class="text-muted">{{ client[4] }}</small>
                      {% else %}
                        <small class="text-muted">لا توجد أرقام</small>
                      {% endif %}
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/client/{{ client[0] }}" class="btn btn-outline-success btn-sm">
                          <i class="fas fa-eye"></i> عرض
                        </a>
                        <button class="btn btn-outline-primary btn-sm" onclick="editClient({{ client[0] }}, '{{ client[1] }}', '{{ client[2] }}')">
                          <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteClient({{ client[0] }})">
                          <i class="fas fa-trash"></i> حذف
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="text-center py-4">
              <i class="fas fa-users fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">لا توجد عملاء مسجلين</h5>
              <p class="text-muted">ابدأ بإضافة عميل جديد من النموذج أعلاه</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function testQuery() {
      const number = document.getElementById('testNumber').value;
      const resultDiv = document.getElementById('testResult');
      
      if (!number) {
        resultDiv.innerHTML = '<div class="alert alert-warning">يرجى إدخال رقم الهاتف</div>';
        return;
      }
      
      resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري الاستعلام...</div>';
      
      try {
        const response = await fetch(`/api/query_test/${number}`);
        const data = await response.json();
        
        if (data.error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">خطأ: ${data.error}</div>`;
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <h6>نتيجة الاستعلام:</h6>
              <pre class="mb-0" style="font-size: 0.8rem;">${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">خطأ في الشبكة: ${error.message}</div>`;
      }
    }
    
    
    function editClient(id, name, whatsapp) {
      // يمكن إضافة modal للتعديل هنا
      const newName = prompt('اسم العميل الجديد:', name);
      const newWhatsapp = prompt('رقم واتساب الجديد:', whatsapp);
      
      if (newName && newWhatsapp) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/dashboard/edit_client';
        form.innerHTML = `
          <input type="hidden" name="client_id" value="${id}">
          <input type="hidden" name="name" value="${newName}">
          <input type="hidden" name="whatsapp" value="${newWhatsapp}">
        `;
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function deleteClient(id) {
      if (confirm('هل أنت متأكد من حذف العميل وجميع أرقامه؟')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/dashboard/delete_client';
        form.innerHTML = `<input type="hidden" name="client_id" value="${id}">`;
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Node.js Server Management Functions
    async function checkServerStatus() {
      try {
        const response = await fetch('/api/node-server/status');
        const data = await response.json();
        
        if (data.success) {
          const status = data.data;
          const statusDiv = document.getElementById('serverStatus');
          const startBtn = document.getElementById('startServerBtn');
          const stopBtn = document.getElementById('stopServerBtn');
          const restartBtn = document.getElementById('restartServerBtn');
          
          if (status.is_running) {
            statusDiv.innerHTML = `
              <div class="d-flex align-items-center">
                <i class="fas fa-circle text-success me-2"></i>
                <span class="text-success fw-bold">الخادم يعمل</span>
                <small class="text-muted ms-2">(PID: ${status.pid}, المنفذ: ${status.port})</small>
              </div>
            `;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            restartBtn.disabled = false;
          } else {
            statusDiv.innerHTML = `
              <div class="d-flex align-items-center">
                <i class="fas fa-circle text-danger me-2"></i>
                <span class="text-danger fw-bold">الخادم متوقف</span>
              </div>
            `;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            restartBtn.disabled = true;
          }
        }
      } catch (error) {
        console.error('خطأ في فحص حالة الخادم:', error);
        document.getElementById('serverStatus').innerHTML = `
          <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <span class="text-warning">خطأ في فحص الحالة</span>
          </div>
        `;
      }
    }

    async function startNodeServer() {
      const messageDiv = document.getElementById('serverMessage');
      const startBtn = document.getElementById('startServerBtn');
      
      startBtn.disabled = true;
      startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التشغيل...';
      messageDiv.innerHTML = '<div class="alert alert-info small">جاري فحص المكتبات وتشغيل الخادم...</div>';
      
      try {
        const response = await fetch('/api/node-server/start', {
          method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
          messageDiv.innerHTML = '<div class="alert alert-success small">تم تشغيل الخادم بنجاح!</div>';
          setTimeout(() => {
            checkServerStatus();
            messageDiv.innerHTML = '';
          }, 2000);
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger small">${data.message}</div>`;
          startBtn.disabled = false;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger small">خطأ في الشبكة: ${error.message}</div>`;
        startBtn.disabled = false;
      }
      
      startBtn.innerHTML = '<i class="fas fa-play"></i> تشغيل الخادم';
    }

    async function stopNodeServer() {
      const messageDiv = document.getElementById('serverMessage');
      const stopBtn = document.getElementById('stopServerBtn');
      
      stopBtn.disabled = true;
      stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإيقاف...';
      messageDiv.innerHTML = '<div class="alert alert-info small">جاري إيقاف الخادم...</div>';
      
      try {
        const response = await fetch('/api/node-server/stop', {
          method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
          messageDiv.innerHTML = '<div class="alert alert-success small">تم إيقاف الخادم بنجاح!</div>';
          setTimeout(() => {
            checkServerStatus();
            messageDiv.innerHTML = '';
          }, 2000);
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger small">${data.message}</div>`;
          stopBtn.disabled = false;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger small">خطأ في الشبكة: ${error.message}</div>`;
        stopBtn.disabled = false;
      }
      
      stopBtn.innerHTML = '<i class="fas fa-stop"></i> إيقاف الخادم';
    }

    async function restartNodeServer() {
      const messageDiv = document.getElementById('serverMessage');
      const restartBtn = document.getElementById('restartServerBtn');
      
      restartBtn.disabled = true;
      restartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري إعادة التشغيل...';
      messageDiv.innerHTML = '<div class="alert alert-info small">جاري إعادة تشغيل الخادم...</div>';
      
      try {
        const response = await fetch('/api/node-server/restart', {
          method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
          messageDiv.innerHTML = '<div class="alert alert-success small">تم إعادة تشغيل الخادم بنجاح!</div>';
          setTimeout(() => {
            checkServerStatus();
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger small">${data.message}</div>`;
          restartBtn.disabled = false;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger small">خطأ في الشبكة: ${error.message}</div>`;
        restartBtn.disabled = false;
      }
      
      restartBtn.innerHTML = '<i class="fas fa-redo"></i> إعادة تشغيل';
    }

    // Initialize server status check on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkServerStatus();
      // Auto-refresh server status every 30 seconds
      setInterval(checkServerStatus, 30000);
    });
  </script>
</body>
</html>
