<!-- templates/packages.html -->
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إدارة الباقات</title>

  <!-- Bootstrap (CDN) -->
  <!-- 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css"> -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { background: #f7f8fb; }
    .container { max-width: 980px; }
    .table-wrap { background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 6px 18px rgba(17,24,39,0.06); }
    .small-muted { font-size: .85rem; color: #6b7280; }
    
        body {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
          background: rgba(255, 255, 255, 0.95) !important;
          backdrop-filter: blur(10px);
          border-radius: 15px;
          margin-bottom: 20px;
        }
        .card {
          background: rgba(255, 255, 255, 0.95);
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
          border: none;
        }
        .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          border-radius: 25px;
        }
        .btn-success {
          background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
          border: none;
          border-radius: 25px;
        }
    
  </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="#">
              <i class="fas fa-robot"></i> بوت واتساب
            </a>
            <div class="navbar-nav me-auto">
              <a class="nav-link active" href="/dashboard">
                <i class="fas fa-tachometer-alt"></i> لوحة الإدارة
              </a>
              <a class="nav-link" href="/history">
                <i class="fas fa-history"></i> سجلات الاستعلام
              </a>
              <a class="nav-link" href="/whatsapp">
                <i class="fab fa-whatsapp"></i> إدارة بوت واتساب
              </a>
              <a href="/packages" class="nav-link">
                <i class="fab fa-whatsapppp"></i> إدارة الباقات
              </a>
            </div>
          </div>
        </nav>
  <div class="container my-4">
    <div class="d-flex align-items-center mb-3">
      <h3 class="me-3">إدارة الباقات</h3>
      
      <div class="ms-auto">
        <button id="btnReload" class="btn btn-outline-secondary btn-sm">تحديث</button>
        <button id="btnAdd" class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#modalPackage">إضافة باقة</button>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table table-hover align-middle" id="packagesTable">
        <thead class="table-light">
          <tr>
            <th style="width:70px">#</th>
            <th>قيمة الباقة (نقود)</th>
            <th>حجم الباقة (GB)</th>
            <th style="width:220px">إجراءات</th>
          </tr>
        </thead>
        <tbody id="packagesBody">
          <!-- rows loaded by JS -->
        </tbody>
      </table>

      <div id="emptyState" class="text-center py-4 text-muted" style="display:none;">
        لا توجد باقات حتى الآن. اضغط "إضافة باقة" لإدخال باقة جديدة.
      </div>
    </div>

    <hr class="my-4">

    <div class="small-muted">
      لربط هذه الصفحة بمشروعك: أضف الرابط التالي في أي مكان داخل صفحاتك:
      <pre class="mt-2"><code>&lt;a href="/packages" class="btn btn-link"&gt;إدارة الباقات&lt;/a&gt;</code></pre>
      (تفترض أن لديك route في Flask يعيد هذه القالب، مثلاً `@app.route('/packages') def packages(): return render_template('packages.html')`)
    </div>
  </div>

  <!-- Modal لإضافة/تعديل -->
  <div class="modal fade" id="modalPackage" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" dir="rtl">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">إضافة باقة جديدة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="packageForm">
          <div class="modal-body">
            <input type="hidden" id="pkgId" value="">
            <div class="mb-3">
              <label class="form-label">قيمة الباقة (نقداً)</label>
              <input type="number" step="0.01" min="0" id="pkgValue" class="form-control" required placeholder="قيمة الباقة مثل 40300">
            </div>
            <div class="mb-3">
              <label class="form-label">حجم الباقة (GB)</label>
              <input type="number" step="0.001" min="0" id="pkgVolume" class="form-control" required placeholder="حجم الباقة بالجيجا مثل 389.09">
            </div>
            <div id="formAlert" class="alert alert-danger py-2" style="display:none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">حفظ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete confirm modal -->
  <div class="modal fade" id="modalDelete" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content" dir="rtl">
        <div class="modal-body text-center py-4">
          <p class="mb-3">هل أنت متأكد أنك تريد حذف هذه الباقة؟</p>
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
            <button id="confirmDeleteBtn" class="btn btn-danger">حذف</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // نقاط التهيئة: عدل مسارات الAPI إن لزم
    const API_BASE = '/api'; // <-- عدل هذا إذا endpoint مختلف
    const URL_LIST = `${API_BASE}/packages`;
    const URL_ITEM = id => `${API_BASE}/packages/${id}`;

    const packagesBody = document.getElementById('packagesBody');
    const emptyState = document.getElementById('emptyState');
    const btnReload = document.getElementById('btnReload');

    const modalPackage = new bootstrap.Modal(document.getElementById('modalPackage'));
    const modalDelete = new bootstrap.Modal(document.getElementById('modalDelete'));
    const pkgForm = document.getElementById('packageForm');
    const pkgId = document.getElementById('pkgId');
    const pkgValue = document.getElementById('pkgValue');
    const pkgVolume = document.getElementById('pkgVolume');
    const formAlert = document.getElementById('formAlert');
    const saveBtn = document.getElementById('saveBtn');

    let deleteCandidateId = null;

    async function fetchPackages() {
      packagesBody.innerHTML = '<tr><td colspan="4" class="text-center py-3">تحميل...</td></tr>';
      try {
        const res = await fetch(URL_LIST);
        if (!res.ok) throw new Error(`خطأ في جلب الباقات: ${res.status}`);
        const data = await res.json();
        renderPackages(data || []);
      } catch (err) {
        packagesBody.innerHTML = `<tr><td colspan="4" class="text-danger text-center py-3">فشل في جلب الباقات — ${err.message}</td></tr>`;
      }
    }

    function renderPackages(list) {
      if (!list || list.length === 0) {
        packagesBody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      packagesBody.innerHTML = list.map((p, idx) => {
        return `
          <tr>
            <td>${idx+1}</td>
            <td>${p.value ?? ''}</td>
            <td>${(p.volume !== undefined && p.volume !== null) ? Number(p.volume).toLocaleString() : ''}</td>
            <td>
              <button class="btn btn-sm btn-outline-info" onclick="onEdit(${p.id})">تعديل</button>
              <button class="btn btn-sm btn-outline-danger ms-2" onclick="onDelete(${p.id})">حذف</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // زر اضافة: يفتح المودال نظيف
    document.getElementById('btnAdd').addEventListener('click', () => {
      formAlert.style.display = 'none';
      pkgId.value = '';
      pkgValue.value = '';
      pkgVolume.value = '';
      document.getElementById('modalTitle').textContent = 'إضافة باقة جديدة';
      saveBtn.textContent = 'إضافة';
    });

    // submit form
    pkgForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formAlert.style.display = 'none';

      const value = parseFloat(pkgValue.value);
      const volume = parseFloat(pkgVolume.value);

      if (isNaN(value) || value <= 0) {
        formAlert.textContent = 'أدخل قيمة صحيحة للباقـة.';
        formAlert.style.display = 'block';
        return;
      }
      if (isNaN(volume) || volume <= 0) {
        formAlert.textContent = 'أدخل حجم باقة صالح (GB).';
        formAlert.style.display = 'block';
        return;
      }

      saveBtn.disabled = true;
      try {
        const payload = { value, volume };
        let res;
        if (pkgId.value) {
          // تعديل
          res = await fetch(URL_ITEM(pkgId.value), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          // إضافة
          res = await fetch(URL_LIST, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }

        // تحديث القائمة وإغلاق المودال
        await fetchPackages();
        modalPackage.hide();
      } catch (err) {
        formAlert.textContent = 'حصل خطأ: ' + err.message;
        formAlert.style.display = 'block';
      } finally {
        saveBtn.disabled = false;
      }
    });

    // فتح تعديل ببيانات الباقة
    window.onEdit = async function(id) {
      formAlert.style.display = 'none';
      document.getElementById('modalTitle').textContent = 'تعديل الباقة';
      saveBtn.textContent = 'حفظ التغييرات';
      try {
        const res = await fetch(URL_ITEM(id));
        if (!res.ok) throw new Error('فشل في جلب الباقة');
        const p = await res.json();
        pkgId.value = p.id;
        pkgValue.value = p.value;
        pkgVolume.value = p.volume;
        modalPackage.show();
      } catch (err) {
        alert('خطأ: ' + err.message);
      }
    };

    // حذف
    window.onDelete = function(id) {
      deleteCandidateId = id;
      modalDelete.show();
    };

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (!deleteCandidateId) return;
      try {
        const res = await fetch(URL_ITEM(deleteCandidateId), { method: 'DELETE' });
        if (!res.ok) throw new Error('فشل الحذف');
        await fetchPackages();
      } catch (err) {
        alert('خطأ: ' + err.message);
      } finally {
        deleteCandidateId = null;
        modalDelete.hide();
      }
    });

    btnReload.addEventListener('click', fetchPackages);

    // تحميل أولي
    fetchPackages();
  </script>
</body>
</html>
