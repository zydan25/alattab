<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>الاستعلام التلقائي اليومي</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin-bottom: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 25px;
    }
    .btn-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      border: none;
      border-radius: 25px;
    }
  </style>
</head>
<body>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-clock"></i> الاستعلام التلقائي اليومي</h2>
        <a href="/dashboard" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i> العودة للوحة التحكم
        </a>
    </div>

    <!-- Status Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-power-off"></i> حالة النظام</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4>
                        <span id="status-text">جارٍ التحميل...</span>
                        <span id="status-icon"></span>
                    </h4>
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle"></i> 
                        يتم مراقبة أوقات الاستعلام التلقائي لجميع العملاء كل دقيقة
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="toggle-btn" class="btn btn-lg" onclick="toggleAutoQuery()" disabled>
                        <i class="fas fa-spinner fa-spin"></i> جارٍ التحميل...
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-primary"><i class="fas fa-users"></i></h3>
                    <h4 id="total-customers">0</h4>
                    <p class="text-muted mb-0">إجمالي العملاء</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-success"><i class="fas fa-check-circle"></i></h3>
                    <h4 id="enabled-customers">0</h4>
                    <p class="text-muted mb-0">العملاء المفعلين</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-warning"><i class="fas fa-phone"></i></h3>
                    <h4 id="total-numbers">0</h4>
                    <p class="text-muted mb-0">إجمالي الأرقام</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-info"><i class="fas fa-history"></i></h3>
                    <h4 id="last-run">لم يتم التشغيل</h4>
                    <p class="text-muted mb-0">آخر تشغيل</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Customers Schedule Table -->
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> جدول أوقات الاستعلام التلقائي</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="schedule-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم العميل</th>
                            <th>عدد الأرقام</th>
                            <th>وقت الاستعلام</th>
                            <th>الحالة</th>
                            <th>آخر استعلام تلقائي</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-tbody">
                        <tr>
                            <td colspan="6" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> جارٍ التحميل...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div class="card shadow mt-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-list"></i> سجل الاستعلامات التلقائية</h5>
        </div>
        <div class="card-body">
            <div id="logs-container" style="max-height: 400px; overflow-y: auto;">
                <p class="text-muted text-center">لا توجد سجلات بعد...</p>
            </div>
        </div>
    </div>
</div>

<script>
let autoRefresh;

// Load status on page load
$(document).ready(function() {
    loadStatus();
    loadSchedule();
    // Auto refresh every 30 seconds
    autoRefresh = setInterval(function() {
        loadStatus();
        loadSchedule();
    }, 30000);
});

// Load system status
function loadStatus() {
    $.get('/api/auto-query/status', function(data) {
        const isRunning = data.running;
        
        // Update status text
        if (isRunning) {
            $('#status-text').html('<span class="text-success">النظام مفعّل ويعمل</span>');
            $('#status-icon').html('<span class="badge bg-success"><i class="fas fa-check"></i> مفعّل</span>');
            $('#toggle-btn')
                .removeClass('btn-success')
                .addClass('btn-danger')
                .html('<i class="fas fa-stop"></i> إيقاف النظام')
                .prop('disabled', false);
        } else {
            $('#status-text').html('<span class="text-danger">النظام متوقف</span>');
            $('#status-icon').html('<span class="badge bg-danger"><i class="fas fa-times"></i> متوقف</span>');
            $('#toggle-btn')
                .removeClass('btn-danger')
                .addClass('btn-success')
                .html('<i class="fas fa-play"></i> تشغيل النظام')
                .prop('disabled', false);
        }
        
        // Update statistics
        $('#total-customers').text(data.total_customers || 0);
        $('#enabled-customers').text(data.enabled_customers || 0);
        $('#total-numbers').text(data.total_numbers || 0);
        $('#last-run').text(data.last_run || 'لم يتم التشغيل');
    }).fail(function() {
        $('#status-text').html('<span class="text-warning">خطأ في تحميل البيانات</span>');
    });
}

// Load schedule table
function loadSchedule() {
    $.get('/api/auto-query/schedule', function(data) {
        const tbody = $('#schedule-tbody');
        tbody.empty();
        
        if (data.customers && data.customers.length > 0) {
            data.customers.forEach(function(customer, index) {
                const statusBadge = customer.enabled 
                    ? '<span class="badge bg-success"><i class="fas fa-check"></i> مفعّل</span>'
                    : '<span class="badge bg-danger"><i class="fas fa-times"></i> معطّل</span>';
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${customer.name}</td>
                        <td><span class="badge bg-info">${customer.numbers_count}</span></td>
                        <td><strong>${customer.auto_query_time}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${customer.last_auto_query || 'لم يتم بعد'}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        } else {
            tbody.html('<tr><td colspan="6" class="text-center text-muted">لا يوجد عملاء مفعلين</td></tr>');
        }
    });
}

// Toggle auto query
function toggleAutoQuery() {
    const btn = $('#toggle-btn');
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> جارٍ المعالجة...');
    
    $.post('/api/auto-query/toggle', function(data) {
        loadStatus();
        
        const message = data.running 
            ? '✅ تم تفعيل النظام بنجاح!' 
            : '⚠️ تم إيقاف النظام';
        
        alert(message);
    }).fail(function() {
        alert('❌ حدث خطأ في تغيير حالة النظام');
        btn.prop('disabled', false);
    });
}
</script>

<style>
.card {
    border-radius: 10px;
}
.table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.badge {
    font-size: 0.9em;
}
#logs-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    font-family: monospace;
}
    </style>
   
